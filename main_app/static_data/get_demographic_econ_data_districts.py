import requests
import os
import time
import pandas as pd

base_url = 'https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=1811939517,1811939484,1811939473,1811939485,1811939510,1811939486,1811939511,1811939496,1811939479,1811939487,1811939474,1811939488,1811939489,1811939497,1811939480,1811939499,1811939524,1811939490,1811939481,1811939512,1811939491,1811939500,1811939482,1811939519,1811939513,1811939475,1811939492,1811939520,1811939501,1811939514,1811939515,1811939476,1811939493,1811939483,1811939516,1811939477,1811939503,1811939505,1811939494,1811939506,1811939478,1811939495,1811939507,1811939509,1811939525,1811939407,1811939436,1811939437,1811939415,1811939408,1811939422,1811939438,1811939416,1811939409,1811939403,1811939410,1811939423,1811939411,1811939439,1811939417,1811939412,1811939418,1811939404,1811939424,1811939440,1811939419,1811939441,1811939413,1811939425,1811939768,1811939420,1811939405,1811939421,1811939442,1811939406,1811939414,1811939426...1811939428,1811939769,1811939540...1811939544,1811939526,1811939527,1811939545...1811939548,1811939528...1811939530,1811939549...1811939552,1811939531,1811939532,1811939553,1811939533,1811939534,1811939554,1811939535,1811939555,1811939556,1811939536,1811939557,1811939537,1811939558,1811939538,1811939539,1811939330,1811939329,1811939338,1811939331,1811939332,1811939339,1811939340,1811939334,1811939335,1811939341,1811939336,1811939342,1811939349,1811939350,1811939343,1811939344,1811939355,1811939365,1811939356,1811939351,1811939345,1811939346,1811939366,1811939352,1811939353,1811939367,1811939347,1811939368,1811939377,1811939369,1811939378,1811939357,1811939358,1811939370...1811939372,1811939359,1811939373,1811939360,1811939379,1811939354,1811939374,1811939380,1811939361...1811939363,1811939348,1811939375,1811939364,1811939381,1811939376,1811939693...1811939696,1811939704,1811939697...1811939703,1811939708,1811939710,1811939712...1811939716,1811939707,1811939717,1811939719,1811939720,1811939722...1811939730,1811939621,1811939622,1811939592,1811939581,1811939559,1811939560,1811939575,1811939593,1811939605,1811939623,1811939624,1811939594,1811939595,1811939582,1811939576,1811939583,1811939610,1811939611,1811939584,1811939599,1811939585,1811939596,1811939612,1811939586,1811939577,1811939587,1811939625,1811939561,1811939578,1811939597,1811939562,1811939626,1811939563,1811939613,1811939588,1811939606,1811939564,1811939565,1811939614,1811939579,1811939615,1811939589,1811939598,1811939566,1811939607,1811939567,1811939616,1811939617,1811939601,1811939618,1811939590,1811939602...1811939604,1811939608,1811939619,1811939580,1811939568,1811939609,1811939591,1811939569,1811939620,1811939570,1811939627,1811939628,1811939649,1811939630,1811939656,1811939631,1811939657,1811939655,1811939640,1811939641,1811939658,1811939659,1811939632,1811939662,1811939642,1811939643,1811939633,1811939634,1811939663,1811939667,1811939636,1811939644,1811939664,1811939660,1811939637,1811939645,1811939661,1811939638,1811939646,1811939647,1811939639,1811939689,1811939680,1811939688,1811939683,1811939677,1811939675,1811939670...1811939672,1811939669,1811939668,1811939687,1811939691,1811939679,1811939692,1811939676,1811939674,1811939685,1811939678,1811939690,1811939682,1811939673,1811939460,1811939467,1811939447,1811939461,1811939462,1811939448,1811939443,1811939449,1811939468,1811939450,1811939455,1811939456,1811939469,1811939457,1811939463,1811939444,1811939464,1811939451...1811939453,1811939445,1811939458,1811939454,1811939446,1811939465,1811939459,1811939466,1811939470...1811939472,1811939394,1811939398,1811939399,1811939387,1811939395,1811939382,1811939388,1811939389,1811939383,1811939400,1811939401,1811939384,1811939385,1811939390,1811939396,1811939391...1811939393,1811939397,1811939402,1811939386&date=latestMINUS36,latestMINUS32,latestMINUS28,latestMINUS24,latestMINUS20,latestMINUS16,latestMINUS12,latestMINUS8,latestMINUS4,latest&variable=248,249,111,18...25,1493...1499,1487,45,558...562,564...568,197...206,434...437,1329...1338,1463,1072,1075...1081,1084...1090,1093...1099,1102...1108,1111...1117,1120...1125,290,293...299,302...308,311...317,320...326,329...335,338...344,347...352,720...722,1,2,8...13,84...91&measures=20599,21001,21002,21003&select=date_name,geography_name,geography_code,variable_name,measures_name,obs_value,obs_status_name&RecordOffset='
script_directory = os.path.dirname(os.path.abspath(__file__))
filename_prefix = 'nomis-api-data'
subdirectory = 'data'
save_directory = os.path.join(script_directory, subdirectory)

counter = 0
for i in range(0,2395800,25000):
    print(f"Sending API request with RecordOffset={i}")
    url = f"{base_url}{i}"
    response = requests.get(url)
    if response.status_code == 200:
        filename = f"{filename_prefix}{counter}.csv"
        counter += 1
        file_path = os.path.join(save_directory, filename)
        with open(file_path, 'wb') as file:
            file.write(response.content)
            print(f'Saved {filename} successfully.')
    else:
        print(f'Error occurred while making the API call: {response.status_code}')
    time.sleep(0.5)    